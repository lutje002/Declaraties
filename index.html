  <!DOCTYPE html>
  <html>
  <head>
      <title>NCubed Declaraties</title>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
      <style>
          body {
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 20px;
              background-color: #f5f5f5;
          }
          .container {
              max-width: 1200px;
              margin: 0 auto;
              background-color: white;
              padding: 20px;
              border-radius: 8px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          h1 {
              color: #333;
              margin-bottom: 20px;
          }
          .upload-container {
              border: 2px dashed #2196F3;
              padding: 20px;
              text-align: center;
              margin: 20px 0;
              border-radius: 8px;
              background-color: #f8f9fa;
          }
          .dragover {
              background-color: #e3f2fd;
              border-color: #1976D2;
          }
          button {
              background-color: #2196F3;
              color: white;
              padding: 10px 20px;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              margin: 5px;
              font-size: 14px;
              transition: background-color 0.3s;
          }
          button:hover {
              background-color: #1976D2;
          }
          .clear-button {
              background-color: #f44336;
          }
          .clear-button:hover {
              background-color: #d32f2f;
          }
          .mail-button {
              background-color: #4CAF50;
          }
          .mail-button:hover {
              background-color: #388E3C;
          }
          table {
              width: 100%;
              border-collapse: collapse;
              margin: 20px 0;
              background-color: white;
          }
          th, td {
              border: 1px solid #ddd;
              padding: 12px;
              text-align: left;
          }
          th {
              background-color: #f5f5f5;
              font-weight: bold;
          }
          tr:nth-child(even) {
              background-color: #f9f9f9;
          }
          tr:hover {
              background-color: #f5f5f5;
          }
          .preview-container {
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
              gap: 15px;
              margin: 20px 0;
          }
          .receipt-container {
              position: relative;
              background: white;
              padding: 10px;
              border-radius: 8px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          .receipt-image {
              width: 100%;
              height: auto;
              border-radius: 4px;
              display: block;
          }
          .receipt-number {
              position: absolute;
              top: 5px;
              left: 5px;
              background-color: #2196F3;
              color: white;
              padding: 5px 10px;
              border-radius: 4px;
              font-weight: bold;
          }
          .editable-amount {
              cursor: pointer;
              padding: 5px;
              border: 1px solid transparent;
              border-radius: 4px;
          }
          .editable-amount:hover {
              background-color: #e3f2fd;
              border-color: #2196F3;
          }
          .editable-amount input {
              width: 100px;
              padding: 5px;
              border: 1px solid #2196F3;
              border-radius: 4px;
          }
          .category-select {
              width: 100%;
              padding: 8px;
              border: 1px solid #ddd;
              border-radius: 4px;
              background-color: white;
          }
          .warning {
              background-color: #fff3cd;
              color: #856404;
              padding: 12px;
              margin: 10px 0;
              border: 1px solid #ffeeba;
              border-radius: 4px;
              display: none;
          }
          #loadingIndicator {
              display: none;
              text-align: center;
              padding: 20px;
              background-color: rgba(255,255,255,0.8);
              position: fixed;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              border-radius: 8px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.2);
          }
          .total-row {
              font-weight: bold;
              background-color: #e3f2fd !important;
          }
      </style>
  </head>
  <body>
      <div class="container">
          <h1>NCubed Declaraties</h1>
          
          <div class="upload-container" id="dropZone">
              <input type="file" id="photoInput" accept="image/*" multiple style="display: none;">
              <button onclick="document.getElementById('photoInput').click()">Upload Bonnetjes</button>
              <p>Of sleep bonnetjes hierheen</p>
              <div id="previewContainer" class="preview-container"></div>
          </div>

          <div id="warning" class="warning"></div>
          <div id="loadingIndicator">Verwerken...</div>

          <div id="declarationContainer">
              <table id="declarationTable">
                  <thead>
                      <tr>
                          <th>Bon #</th>
                          <th>Datum</th>
                          <th>Naam</th>
                          <th>Categorie</th>
                          <th>Bedrag</th>
                          <th>Actie</th>
                      </tr>
                  </thead>
                  <tbody id="declarationBody"></tbody>
                  <tfoot>
                      <tr class="total-row">
                          <td colspan="4">Totaal</td>
                          <td id="declarationTotal">€0,00</td>
                          <td></td>
                      </tr>
                  </tfoot>
              </table>

              <div style="margin-top: 20px; text-align: right;">
                  <button onclick="clearAll()" class="clear-button">Clear Alles</button>
                  <button onclick="generatePDF()">Download PDF</button>
                  <button onclick="sendEmailOnly()" class="mail-button">Verstuur Mail</button>
              </div>
          </div>
      </div>

      <script>
          const CATEGORIES = [
              "Reiskosten - OV",
              "Reiskosten - Auto",
              "Reiskosten - Taxi",
              "Reiskosten - Vliegtickets",
              "Reiskosten - Parkeren",
              "Kantoorartikelen",
              "Kantoor - Meubilair",
              "Kantoor - Apparatuur",
              "ICT - Hardware",
              "ICT - Software",
              "ICT - Cloud Services",
              "ICT - Telefonie",
              "Representatie - Lunch",
              "Representatie - Diner",
              "Representatie - Koffie",
              "Representatie - Relatiegeschenken",
              "Opleiding - Cursussen",
              "Opleiding - Boeken",
              "Opleiding - Conferenties",
              "Marketing - Advertenties",
              "Marketing - Promotiemateriaal",
              "Verblijfskosten - Hotel",
              "Verblijfskosten - Overig",
              "Verzekeringen",
              "Abonnementen",
              "Overig"
          ].sort();

          const MONICA_API_KEY = 'sk-74PDyAlNKWSTMSF00qpvh0Z0WuGzpriVmWDBdMAUHED9PSmGLcMCZ4ByElHRwX7ch8wgghmnusYT2Zcb2QLpRbaG_heD';
          const IMGBB_API_KEY = '56fb3a05b4ed17c9e72b3cfb52caddb8';
          
          let processedData = [];
          let receiptImages = [];

          // Drag and drop handlers
          const dropZone = document.getElementById('dropZone');
          const photoInput = document.getElementById('photoInput');

          dropZone.addEventListener('dragover', (e) => {
              e.preventDefault();
              dropZone.classList.add('dragover');
          });

          dropZone.addEventListener('dragleave', () => {
              dropZone.classList.remove('dragover');
          });

          dropZone.addEventListener('drop', (e) => {
              e.preventDefault();
              dropZone.classList.remove('dragover');
              handleFiles(e.dataTransfer.files);
          });

          photoInput.addEventListener('change', (e) => {
              handleFiles(e.target.files);
          });

          function clearAll() {
              document.getElementById('previewContainer').innerHTML = '';
              document.getElementById('declarationBody').innerHTML = '';
              document.getElementById('declarationTotal').textContent = '€0,00';
              processedData = [];
              receiptImages = [];
              photoInput.value = '';
          }

          async function handleFiles(files) {
              const previewContainer = document.getElementById('previewContainer');
              
              for (const file of files) {
                  if (file.type.startsWith('image/')) {
                      const reader = new FileReader();
                      
                      reader.onload = async (e) => {
                          const receiptNumber = receiptImages.length + 1;
                          
                          const receiptContainer = document.createElement('div');
                          receiptContainer.className = 'receipt-container';
                          
                          const numberLabel = document.createElement('div');
                          numberLabel.className = 'receipt-number';
                          numberLabel.textContent = receiptNumber;
                          
                          const img = document.createElement('img');
                          img.src = e.target.result;
                          img.className = 'receipt-image';
                          
                          receiptContainer.appendChild(numberLabel);
                          receiptContainer.appendChild(img);
                          previewContainer.appendChild(receiptContainer);
                          
                          receiptImages.push({
                              number: receiptNumber,
                              data: e.target.result
                          });
                          
                          await processImage(e.target.result, receiptNumber);
                      };
                      
                      reader.readAsDataURL(file);
                  }
              }
          }

          function makeEditable(element) {
              const currentValue = element.textContent.replace('€', '');
              const input = document.createElement('input');
              input.type = 'number';
              input.step = '0.01';
              input.value = currentValue;
              
              input.onblur = function() {
                  const newValue = parseFloat(this.value);
                  if (!isNaN(newValue)) {
                      element.textContent = `€${newValue.toFixed(2)}`;
                  } else {
                      element.textContent = `€${currentValue}`;
                  }
                  updateTotal();
              };
              
              input.onkeypress = function(e) {
                  if (e.key === 'Enter') {
                      this.blur();
                  }
              };
              
              element.textContent = '';
              element.appendChild(input);
              input.focus();
          }

          async function processImage(imageData, receiptNumber) {
              const loadingIndicator = document.getElementById('loadingIndicator');
              try {
                  loadingIndicator.style.display = 'block';
                  
                  const base64Image = imageData.split(',')[1];
                  const formData = new FormData();
                  formData.append('image', base64Image);
                  
                  const uploadResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                      method: 'POST',
                      body: formData
                  });
                  
                  if (!uploadResponse.ok) throw new Error('Upload failed');
                  
                  const uploadResult = await uploadResponse.json();
                  const imageUrl = uploadResult.data.url;
                  
                  const response = await fetch('https://old-voice-773e.r-lutjenkossink.workers.dev/monica', {
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json',
                          'Authorization': `Bearer ${MONICA_API_KEY}`
                      },
                      body: JSON.stringify({
                          model: "gpt-4o",
                          messages: [{
                              role: "user",
                              content: [
                                  {
                                      type: "text",
                                      text: "Analyseer deze bon. Geef de datum, naam van het bedrijf en totaalbedrag. Format: datum, naam, bedrag"
                                  },
                                  {
                                      type: "image_url",
                                      image_url: {
                                          url: imageUrl
                                      }
                                  }
                              ]
                          }]
                      })
                  });
                  
                  if (!response.ok) throw new Error('Analysis failed');
                  
                  const data = await response.json();
                  addToTable(data.choices[0].message.content, receiptNumber);
                  
              } catch (error) {
                  showWarning(`Fout bij verwerking van bon #${receiptNumber}: ${error.message}`);
              } finally {
                  loadingIndicator.style.display = 'none';
              }
          }

          function addToTable(content, receiptNumber) {
              const tbody = document.getElementById('declarationBody');
              const [date, name, amount] = content.split(',').map(item => item.trim());
              
              const row = document.createElement('tr');
              const parsedAmount = parseFloat(amount);
              
              const amountCell = document.createElement('td');
              amountCell.className = 'editable-amount';
              amountCell.textContent = !isNaN(parsedAmount) ? `€${parsedAmount.toFixed(2)}` : '€0.00';
              amountCell.onclick = () => makeEditable(amountCell);

              const categorySelect = document.createElement('select');
              categorySelect.className = 'category-select';
              categorySelect.innerHTML = CATEGORIES.map(cat => 
                  `<option value="${cat}">${cat}</option>`
              ).join('');

              row.innerHTML = `
                  <td>${receiptNumber}</td>
                  <td>${date || 'Onbekend'}</td>
                  <td>${name || 'Onbekend'}</td>
                  <td></td>
                  <td></td>
                  <td>
                      <button onclick="this.closest('tr').remove(); updateTotal()" class="clear-button">
                          ✕
                      </button>
                  </td>
              `;

              row.cells[3].appendChild(categorySelect);
              row.cells[4].replaceWith(amountCell);
              
              tbody.appendChild(row);
              updateTotal();

              if (isNaN(parsedAmount)) {
                  showWarning(`Bon #${receiptNumber}: Geen bedrag gevonden. Klik op €0.00 om handmatig in te vullen.`);
              }
          }

          function showWarning(message) {
              const warning = document.getElementById('warning');
              warning.textContent = message;
              warning.style.display = 'block';
              setTimeout(() => warning.style.display = 'none', 5000);
          }

          function updateTotal() {
              const rows = document.querySelectorAll('#declarationBody tr');
              let total = 0;
              
              rows.forEach(row => {
                  const amount = parseFloat(row.cells[4].textContent.replace('€', ''));
                  if (!isNaN(amount)) total += amount;
              });
              
              document.getElementById('declarationTotal').textContent = `€${total.toFixed(2)}`;
          }

          function generatePDF() {
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF();
              
              const currentDate = new Date().toLocaleDateString('nl-NL');
              
              // Add header
              doc.setFontSize(16);
              doc.text('Declaratie Overzicht', 20, 20);
              
              doc.setFontSize(12);
              doc.text(`Datum: ${currentDate}`, 20, 30);
              
              // Add table
              const tableData = Array.from(document.querySelectorAll('#declarationBody tr')).map(row => [
                  row.cells[0].textContent,
                  row.cells[1].textContent,
                  row.cells[2].textContent,
                  row.cells[3].querySelector('select').value,
                  row.cells[4].textContent
              ]);

              doc.autoTable({
                  startY: 40,
                  head: [['Bon #', 'Datum', 'Naam', 'Categorie', 'Bedrag']],
                  body: tableData,
                  foot: [[
                      {content: 'Totaal', colSpan: 4},
                      document.getElementById('declarationTotal').textContent
                  ]],
              });

              // Add images
              let y = doc.lastAutoTable.finalY + 20;
              
              receiptImages.forEach((receipt, index) => {
                  if (y + 100 > doc.internal.pageSize.height) {
                      doc.addPage();
                      y = 20;
                  }
                  
                  doc.text(`Bon #${receipt.number}:`, 20, y);
                  y += 10;
                  
                  try {
                      doc.addImage(receipt.data, 'JPEG', 20, y, 170, 0);
                      y += 120;
                  } catch (error) {
                      console.error('Error adding image:', error);
                  }
              });
              
              doc.save(`Declaratie_${currentDate.replace(/\//g, '-')}.pdf`);
          }

          function sendEmailOnly() {
              const rows = document.querySelectorAll('#declarationBody tr');
              const categories = {};
              
              rows.forEach(row => {
                  const category = row.cells[3].querySelector('select').value;
                  const amount = parseFloat(row.cells[4].textContent.replace('€', ''));
                  if (!categories[category]) categories[category] = 0;
                  if (!isNaN(amount)) categories[category] += amount;
              });

              let emailBody = 'Beste,\n\nHierbij mijn declaratie.\n\nSpecificatie:\n\n';
              
              Object.entries(categories)
                  .sort(([a], [b]) => a.localeCompare(b))
                  .forEach(([category, amount]) => {
                      emailBody += `${category}: €${amount.toFixed(2)}\n`;
                  });
              
              emailBody += `\nTotaalbedrag: ${document.getElementById('declarationTotal').textContent}\n\n`;
              emailBody += 'Met vriendelijke groet,\nRené Lutjenkossink';
              
              const mailtoLink = `mailto:invoices@ncubed.nl?cc=r.lutjenkossink@ncubed.nl&subject=Declaratie ${new Date().toLocaleDateString('nl-NL')}&body=${encodeURIComponent(emailBody)}`;
              window.location.href = mailtoLink;
          }
      </script>
  </body>
  </html>